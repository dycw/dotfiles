#!/usr/bin/env sh
# shellcheck source=/dev/null

# shell - paths (first)
__file="${HOME}/dotfiles/shell/common.sh"
if [ -f "$__file" ]; then
	. "$__file"
fi

# fzf
__file="${HOME}/.config/fzf/fzf.zsh"
if [ -f "$__file" ]; then
	. "$__file"
fi

# zim
export ZIM_HOME="${HOME}/.zim"
if [[ ! -e "${ZIM_HOME}/zimfw.zsh" ]]; then
	# Download zimfw plugin manager if missing.
	curl -fsSL --create-dirs -o "${ZIM_HOME}/zimfw.zsh" \
		https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
fi
if [[ ! "${ZIM_HOME}/init.zsh" -nt "${ZDOTDIR:-${HOME}}/.zimrc" ]]; then
	# Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated.
	source "${ZIM_HOME}/zimfw.zsh" init -q
fi
__file="${ZIM_HOME}/init.zsh"
if [ -f "$__file" ]; then
	. "$__file"
fi
unalias l
unalias ll

# shell - paths (end)

# direnv
if command -v direnv >/dev/null 2>&1; then
	eval "$(direnv hook zsh)"
fi

# docker
__dir="${HOME}/.docker/completions"
mkdir -p "${__dir}"
if [ -d "${__dir}" ];  then
  FPATH="${__dir}:$FPATH"
  autoload -Uz compinit
fi

# echo
echo_date() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*"; }

# fzf
if command -v fzf >/dev/null 2>&1; then
	eval "$(fzf --zsh)"
fi

# starship
if command -v starship >/dev/null 2>&1; then
	eval "$(starship init zsh)"
fi

# qrt
__dir="${XDG_CONFIG_HOME:-${HOME}/.config}"/qrt/zsh
if [ -d "${__dir}" ]; then
    find -L "${__dir}" -type f -name '*.zsh' | while IFS= read -r __file; do
        . "${__file}"
    done
fi

# uv
if command -v uv >/dev/null 2>&1; then
	eval "$(uv generate-shell-completion zsh)"
	eval "$(uvx --generate-shell-completion zsh)"
fi

# zoxide
if command -v zoxide >/dev/null 2>&1; then
	eval "$(zoxide init zsh --cmd cd --hook prompt)"
	eval "$(zoxide init zsh --cmd j --hook prompt)"
fi

# zsh
zshrc() {
    if [ $# -ne 0 ]; then
        echo_date "'zshrc' accepts no arguments" && return 1
    fi
    ${EDITOR} "${HOME}/.zshrc"
}
zshrc_reload() {
    if [ $# -ne 0 ]; then
f command -v tmux >/dev/null 2>&1; then
    tmux_attach() {
              if [ $# -eq 0 ]; then
                            __count="$(tmux ls 2>/dev/null | wc -l)"
                                        if [ "${__count}" -eq 0 ]; then
                                                          tmux new
                                                                          return
                                                                                      elif [ "${__count}" -eq 1 ]; then
                                                                                                        __session="$(tmux ls | cut -d: -f1)"
                                                                                                                    else
                                                                                                                                      echo_date "ERROR: %d sessions found" "${__count}"
                                                                                                                                                  fi
                                                                                                                                                          elif [ $# -eq 1 ]; then
                                                                                                                                                                        __session="$1"
                                                                                                                                                                                else
                                                                                                                                                                                              echo_date "'tmux_attach' accepts [0..1] arguments" && return 1
                                                                                                                                                                                                      fi
                                                                                                                                                                                                              tmux attach -t "${__session}"
                                                                                                                                                                                                                  }
                                                                                                                                                                                                                    tmux_current_window() {
                                                                                                                                                                                                                              if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                            echo_date "'tmux_detach' accepts no arguments" && return 1
                                                                                                                                                                                                                                                    fi
                                                                                                                                                                                                                                                            tmux display-message -p '#S:#I'
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                  tmux_detach() {
                                                                                                                                                                                                                                                                            if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                          echo_date "'tmux_detach' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                  fi
                                                                                                                                                                                                                                                                                                          tmux detach
                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                tmux_ls() {
                                                                                                                                                                                                                                                                                                                          if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                        echo_date "'tmux_ls' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                fi
                                                                                                                                                                                                                                                                                                                                                        tmux ls
                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                              tmux_reload() {
                                                                                                                                                                                                                                                                                                                                                                        if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                      echo_date "'tmux_reload' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                              fi
                                                                                                                                                                                                                                                                                                                                                                                                      tmux source-file "${XDG_CONFIG_HOME:-"${HOME}/.config"}/tmux/tmux.conf"
                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                            # layouts
                                                                                                                                                                                                                                                                                                                                                                                                            #     tmux_even_horizontal() {
                                                                                                                                                                                                                                                                                                                                                                                                            #             if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                         echo_date "'tmux_even_horizontal' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                 fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                         tmux select-layout -t "$(tmux_current_window)" even-horizontal
                                                                                                                                                                                                                                                                                                                                                                                                            #                                             }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                 tmux_even_vertical() {
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                         if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                     echo_date "'tmux_even_vertical' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                             fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                     tmux select-layout -t "$(tmux_current_window)" even-vertical
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                             tmux_main_horizontal() {
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                     if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                 echo_date "'tmux_main_horizontal' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                         fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                 tmux select-layout -t "$(tmux_current_window)" main-horizontal
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                         tmux_main_horizontal_mirrored() {
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                 if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                             echo_date "'tmux_main_horizontal_mirrored' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                     fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                             tmux select-layout -t "$(tmux_current_window)" main-horizontal-mirrored
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                     tmux_main_vertical() {
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                             if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                         echo_date "'tmux_main_vertical' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                 fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                         tmux select-layout -t "$(tmux_current_window)" main-vertical
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                 tmux_main_vertical_mirrored() {
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                         if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                     echo_date "'tmux_main_vertical_mirrored' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                             fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                     tmux select-layout -t "$(tmux_current_window)" main-vertical-mirrored
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                             tmux_tiled() {
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                     if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                 echo_date "'tmux_tiled' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                         fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                 tmux select-layout -t "$(tmux_current_window)" tiled
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                         if [ -z "$TMUX" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                 # not inside tmux
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                         if [ -z "${SSH_CONNECTION}" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                     # not over SSH
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                 tmux new-session -c "${PWD}"
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                         elif [ -n "$SSH_CONNECTION" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                     # is over SSH
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                 __count="$(tmux ls 2>/dev/null | wc -l)"
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                             if [ "${__count}" -eq 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                             tmux new
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                         elif [ "${__count}" -eq 1 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                         tmux attach -t "$(tmux ls | cut -d: -f1)"
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                     else
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     echo_date "Multiple 'tmux' sessions detected:"
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     tmux ls
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             tmux_conf_local() {
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if [ $# -ne 0 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         echo_date "'tmux_conf_local' accepts no arguments" && return 1
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             fi
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ${EDITOR} "${HOME}"/.config/tmux/tmux.conf.local
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 echo_date "'zshrc_reload' accepts no arguments" && return 1
    fi
    . "${HOME}/.zshrc"
}
